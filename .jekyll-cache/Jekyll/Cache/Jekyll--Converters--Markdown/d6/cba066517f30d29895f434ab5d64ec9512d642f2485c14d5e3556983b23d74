I"Şa<!-- TOC -->

<ul>
  <li><a href="#1-æ‰©æ•£æ¨¡å‹ç®€ä»‹">1. æ‰©æ•£æ¨¡å‹ç®€ä»‹</a></li>
  <li><a href="#2-æ¨¡å‹">2. æ¨¡å‹</a>
    <ul>
      <li><a href="#21-å‰å‘æ‰©æ•£">2.1. å‰å‘æ‰©æ•£</a></li>
      <li><a href="#22-åå‘æ‰©æ•£è¿‡ç¨‹">2.2. åå‘æ‰©æ•£è¿‡ç¨‹</a></li>
      <li><a href="#23-æŸå¤±å‡½æ•°">2.3. æŸå¤±å‡½æ•°</a></li>
      <li><a href="#24-ddpmä¸­ç»™å‡ºçš„è®­ç»ƒä¸é‡‡æ ·ç”Ÿæˆè¿‡ç¨‹">2.4. DDPMä¸­ç»™å‡ºçš„è®­ç»ƒä¸é‡‡æ ·(ç”Ÿæˆ)è¿‡ç¨‹</a></li>
      <li><a href="#25-å°ç»“">2.5. å°ç»“</a></li>
    </ul>
  </li>
  <li><a href="#3-ä¸€äº›æŠ€å·§å’Œä¸»è¦ç½‘ç»œç»“æ„">3. ä¸€äº›æŠ€å·§å’Œä¸»è¦ç½‘ç»œç»“æ„</a>
    <ul>
      <li><a href="#31-\beta_tå’Œ\sigma_\thetaçš„å–å€¼">3.1. $\beta_t$å’Œ$\Sigma_\theta$çš„å–å€¼</a></li>
      <li><a href="#32-åŠ é€Ÿæ‰©æ•£æ¨¡å‹é‡‡æ ·çš„æŠ€å·§">3.2. åŠ é€Ÿæ‰©æ•£æ¨¡å‹é‡‡æ ·çš„æŠ€å·§</a></li>
      <li><a href="#33-u-net">3.3. U-Net</a></li>
    </ul>
  </li>
  <li><a href="#4-æ¡ä»¶ç”Ÿæˆ">4. æ¡ä»¶ç”Ÿæˆ</a>
    <ul>
      <li><a href="#41-classifier-guided-diffusion">4.1. Classifier Guided Diffusion</a></li>
      <li><a href="#42-classifier-free-guidance">4.2. Classifier-Free Guidance</a></li>
      <li><a href="#43-scale-up-generation-resolution-and-quality">4.3. Scale up Generation Resolution and Quality</a></li>
    </ul>
  </li>
</ul>

<!-- /TOC -->

<h1 id="1-æ‰©æ•£æ¨¡å‹ç®€ä»‹">1. æ‰©æ•£æ¨¡å‹ç®€ä»‹</h1>
<p>æ‰©æ•£æ¨¡å‹(Diffusion Model)æ˜¯æ·±åº¦ç”Ÿæˆæ¨¡å‹ä¸­çš„SOTAï¼Œç›¸æ¯”äºGANã€VAEã€Flow-basedè¿™äº›ç”Ÿæˆæ¨¡å‹è€Œè¨€ï¼Œæ‰©æ•£æ¨¡å‹å¯ä»¥å–å¾—æ›´å¥½çš„æ•ˆæœã€‚æ‰©æ•£æ¨¡å‹å—éå¹³è¡¡çƒ­åŠ›å­¦å¯å‘ï¼Œå®ƒå®šä¹‰äº†ä¸€æ¡å¤šæ—¶é—´æ­¥çš„é©¬å°”å¯å¤«é“¾æ¥é€æ­¥ç»™å›¾ç‰‡æ·»åŠ å™ªå£°ï¼Œå¦‚æœæ—¶é—´æ­¥å¤Ÿå¤§ï¼Œæœ€ç»ˆå›¾ç‰‡ä¼šå˜æˆçº¯å™ªå£°ï¼Œæ‰©æ•£æ¨¡å‹çš„ç›®çš„æ˜¯å­¦ä¹ åå‘çš„æ‰©æ•£è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¾“å…¥éšæœºå™ªå£°ï¼Œèƒ½è¿”å›ä¸€å¼ å›¾ç‰‡ï¼Œç›¸æ¯”äºä¹‹å‰æåˆ°çš„å„ç§ç”Ÿæˆæ¨¡å‹è€Œè¨€ï¼Œæ‰©æ•£æ¨¡å‹å…·æœ‰ç›¸å¯¹å›ºå®šçš„å­¦ä¹ æ­¥éª¤ï¼ŒåŒæ—¶éšå˜é‡ç»´åº¦æ›´é«˜(å’Œè¾“å…¥æ•°æ®åŒæ ·çš„ç»´åº¦)</p>

<center><img src="../assets/img/posts/20221012/2.jpg" /></center>

<p>æ‰©æ•£æ¨¡å‹çš„æ—©åœ¨2015å¹´ä¾¿æå‡ºäº†(<a href="https://arxiv.org/abs/1503.03585" target="_blank">è®ºæ–‡é“¾æ¥</a>)ï¼Œä½†åœ¨å½“æ—¶æ²¡æœ‰å¼•èµ·å¹¿æ³›çš„å…³æ³¨ï¼Œç›´åˆ°2019å¹´<a href="https://arxiv.org/abs/1907.05600" target="_blank">NCSN</a>å’Œ2020å¹´<a href="https://arxiv.org/abs/2006.11239" target="_blank">DDPM</a>çš„å‡ºç°æ‰å°†æ‰©æ•£æ¨¡å‹å¼•å…¥äº†æ–°é«˜åº¦ï¼Œ2022å¹´ç«çˆ†çš„text2imageæ¨¡å‹GLIDEã€DALLE2ã€Latent Diffusionã€Imagençš„ç›¸ç»§æå‡ºï¼Œè®©æ‰©æ•£æ¨¡å‹ç«å‡ºäº†åœˆï¼Œè¿™ç¯‡åšå®¢å°†å¯¹æ‰©æ•£æ¨¡å‹çš„å‰å‘è®¡ç®—ã€åå‘è®­ç»ƒã€è®­ç»ƒã€ç”Ÿæˆæ­¥éª¤åŠå…¶æ•°å­¦åŸç†åšè¯¦ç»†çš„æ•´ç†ï¼Œä¼šåˆ—å‡ºå¾ˆå¤šæ•°å­¦å…¬å¼ï¼ŒåŒæ—¶è¯¥åšå®¢ä¹Ÿå‚è€ƒäº†å¾ˆå¤šç›¸å…³èµ„æ–™ï¼Œè¿™é‡Œæˆ‘ä¸€å¹¶åˆ—å‡º</p>

<ul>
  <li><a href="https://lilianweng.github.io/posts/2021-07-11-diffusion-models/" target="_blank">Lil blog, ä¸€ç¯‡æ•´ç†ç›¸å½“è¯¦å°½çš„åšå®¢ï¼Œä¹Ÿæ˜¯æˆ‘ä¸»è¦çš„å‚è€ƒå¯¹è±¡</a></li>
  <li><a href="https://huggingface.co/blog/annotated-diffusion" target="_blank">huggingfaceçš„ä¸€ç¯‡è§£é‡Šç®€å•æ˜äº†çš„åšå®¢</a></li>
  <li><a href="https://zhuanlan.zhihu.com/p/525106459" target="_blank">çŸ¥ä¹ä¸Šä¸€ç¯‡ä¸­æ–‡åšå®¢</a></li>
  <li><a href="https://arxiv.org/abs/2006.11239" target="_blank">DDPM</a></li>
  <li><a href="https://arxiv.org/abs/2209.00796" target="_blank">ä¸€ç¯‡ç»¼è¿°</a></li>
  <li><a href="https://arxiv.org/abs/2102.09672" target="_blank">Improved DDPM</a></li>
  <li><a href="https://arxiv.org/abs/2105.05233" target="_blank">Diffusion Models Beat GANs</a></li>
  <li><a href="https://arxiv.org/abs/2112.10741" target="_blank">GLIDE</a></li>
  <li><a href="https://arxiv.org/abs/2106.15282" target="_blank">Cascaded Diffusion Model</a></li>
</ul>

<h1 id="2-æ¨¡å‹">2. æ¨¡å‹</h1>
<h2 id="21-å‰å‘æ‰©æ•£">2.1. å‰å‘æ‰©æ•£</h2>
<p>ä»åŸå§‹æ•°æ®åˆ†å¸ƒä¸­é‡‡æ ·$x_0$, å‡è®¾$x_0\sim q(x)$ï¼Œå‰å‘æ‰©æ•£è¿‡ç¨‹å°±æ˜¯åœ¨æ¯ä¸€ä¸ªæ—¶é—´æ­¥éƒ½åŠ ä¸Šä¸€ä¸ªé«˜æ–¯å™ªå£°ï¼Œè¿™æ ·å°±å¯ä»¥ä»æœ€åˆçš„$x_0$ç”Ÿæˆé•¿åº¦ä¸ºTçš„å™ªå£°åºåˆ—$x_1, x_2, x_3,â€¦, x_T$ï¼Œæ¯ä¸€æ­¥éƒ½ç”¨variance schedule$\beta_t$æ§åˆ¶ï¼Œå…¶ä¸­$\beta_t\in (0, 1)$ï¼Œæ¯ä¸€æ­¥çš„åéªŒåˆ†å¸ƒ(é¢„å®šä¹‰å¥½çš„)ä¸º:</p>

<p>
\begin{equation}
q(\mathbf{x}_t \vert \mathbf{x}_{t-1}) = \mathcal{N}(\mathbf{x}_t; \sqrt{1 - \beta_t} \mathbf{x}_{t-1}, \beta_t\mathbf{I}) \quad
q(\mathbf{x}_{1:T} \vert \mathbf{x}_0) = \prod^T_{t=1} q(\mathbf{x}_t \vert \mathbf{x}_{t-1})
\end{equation}
</p>

<p>è¿™ä¸ªå‰å‘ä¼ æ’­çš„è¿‡ç¨‹ä¸­æœ‰ä¸€ä¸ªéå¸¸å¥½çš„æ€§è´¨ï¼Œå°±æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨ä»»æ„æ—¶é—´æ­¥é‡‡æ ·å¾—åˆ°$x_t$ï¼Œä¸ºäº†å®ç°è¿™ä¸ªæŠ€å·§ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°reparameterizationæŠ€å·§(è¯¥æŠ€å·§ä¹Ÿåœ¨VAEä¸­å‡ºç°è¿‡)ï¼Œé‡å‚æ•°åŒ–æŠ€å·§çš„æœ¬è´¨å°±æ˜¯å°†éšæœºé‡‡æ ·çš„zé€šè¿‡å¼•å…¥é«˜æ–¯å™ªå£°$\epsilon$å˜æˆç¡®å®šæ€§çš„zï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„$x_t$å¯ä»¥è¡¨ç¤ºä¸º$x_t=\sqrt{1-\beta_t}x_{t-1}+\sqrt{\beta_t}\epsilon$ï¼Œè¿™æ ·æœ‰åˆ©äºæ¢¯åº¦çš„é€†ä¼ æ’­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ¨å‡ºä»¥ä¸‹å…¬å¼:</p>

<p>
\begin{equation}
\begin{aligned}
\mathbf{x}_t 
&amp;= \sqrt{\alpha_t}\mathbf{x}_{t-1} + \sqrt{1 - \alpha_t}\boldsymbol{\epsilon}_{t-1} \\
&amp;= \sqrt{\alpha_t \alpha_{t-1}} \mathbf{x}_{t-2} + \sqrt{1 - \alpha_t \alpha_{t-1}} \bar{\boldsymbol{\epsilon}}_{t-2} \\
&amp;= \dots \\
&amp;= \sqrt{\bar{\alpha}_t}\mathbf{x}_0 + \sqrt{1 - \bar{\alpha}_t}\boldsymbol{\epsilon} \\
q(\mathbf{x}_t \vert \mathbf{x}_0) &amp;= \mathcal{N}(\mathbf{x}_t; \sqrt{\bar{\alpha}_t} \mathbf{x}_0, (1 - \bar{\alpha}_t)\mathbf{I})
\end{aligned}
\end{equation}
</p>

<p>å…¶ä¸­$\epsilon_t$éƒ½æ˜¯å‡å€¼ä¸º0ï¼Œæ–¹å·®ä¸º1çš„é«˜æ–¯å™ªå£°ï¼Œ$\alpha_t=1-\beta_t$, $\bar{\alpha_t}=\prod_{i=1}^t\alpha_i$, æ³¨:ä¸¤ä¸ªå‡å€¼ç›¸åŒé«˜æ–¯å™ªå£°å¯ä»¥åˆå¹¶æˆä¸€ä¸ªé«˜æ–¯å™ªå£°ï¼Œæ–¹å·®ä¸ºä¹‹å‰æ–¹å·®çš„å¹³æ–¹å’Œå¼€æ ¹å·ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œ$\beta_1&lt;\beta_2&lt;â€¦&lt;\beta_T$</p>

<h2 id="22-åå‘æ‰©æ•£è¿‡ç¨‹">2.2. åå‘æ‰©æ•£è¿‡ç¨‹</h2>

<center><img src="../assets/img/posts/20221012/3.jpg" /></center>

<p>å¦‚æœæˆ‘ä»¬å¯ä»¥å°†å‰å‘ä¼ æ’­çš„è¿‡ç¨‹åå‘ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è·å¾—åéªŒåˆ†å¸ƒ$q(x_{t-1}|x_{t})$ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨é©¬å°”ç§‘å¤«é“¾çš„æ€§è´¨ï¼Œè¾“å…¥é«˜æ–¯å™ªå£°ï¼Œç„¶åè·å¾—ç”Ÿæˆçš„ç…§ç‰‡ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬æ— æ³•é«˜æ•ˆåœ°å¾—åˆ°$q(x_{t-1}|x_{t})$ï¼Œäºæ˜¯æˆ‘ä»¬å¸Œæœ›å­¦ä¹ å‡ºåˆ†å¸ƒ$p_\theta$æ¥æ¨¡æ‹ŸåéªŒåˆ†å¸ƒ$q(x_{t-1}|x_{t})$ï¼Œç”±äºå‰å‘æ‰©æ•£çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬å‡è®¾åéªŒåˆ†å¸ƒæ˜¯é«˜æ–¯åˆ†å¸ƒï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¹Ÿå‡è®¾$p_\theta$æ˜¯é«˜æ–¯åˆ†å¸ƒï¼Œäºæ˜¯æˆ‘ä»¬æœ‰:</p>

<p>
\begin{equation}
p_\theta(\mathbf{x}_{0:T}) = p(\mathbf{x}_T) \prod^T_{t=1} p_\theta(\mathbf{x}_{t-1} \vert \mathbf{x}_t) \quad
p_\theta(\mathbf{x}_{t-1} \vert \mathbf{x}_t) = \mathcal{N}(\mathbf{x}_{t-1}; \boldsymbol{\mu}_\theta(\mathbf{x}_t, t), \boldsymbol{\Sigma}_\theta(\mathbf{x}_t, t))
\end{equation}
</p>

<p>å…¶ä¸­åˆ†å¸ƒ$p_\theta$ä¸­çš„å‡å€¼$\mu$å’Œæ–¹å·®$\Sigma$ä¸æ—¶é—´æ­¥tå’Œè¾“å…¥$x_t$æœ‰å…³</p>

<p>è™½ç„¶æˆ‘ä»¬ä¸çŸ¥é“$q(x_{t-1}|x_t)$çš„åˆ†å¸ƒæƒ…å†µï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çŸ¥é“$q(\mathbf{x}_{t-1} \vert \mathbf{x}_t, \mathbf{x}_0)$çš„åˆ†å¸ƒæƒ…å†µï¼Œæ¨å¯¼è¿‡ç¨‹å¦‚ä¸‹:</p>

<p style="font-size: 14px">
\begin{equation}
\begin{aligned}
q\left(\mathbf{x}_{t-1} \mid \mathbf{x}_t, \mathbf{x}_0\right) &amp;=q\left(\mathbf{x}_t \mid \mathbf{x}_{t-1}, \mathbf{x}_0\right) \frac{q\left(\mathbf{x}_{t-1} \mid \mathbf{x}_0\right)}{q\left(\mathbf{x}_t \mid \mathbf{x}_0\right)} \\
&amp; \propto \exp \left(-\frac{1}{2}\left(\frac{\left(\mathbf{x}_t-\sqrt{\alpha_t} \mathbf{x}_{t-1}\right)^2}{\beta_t}+\frac{\left(\mathbf{x}_{t-1}-\sqrt{\bar{\alpha}_{t-1}} \mathbf{x}_0\right)^2}{1-\bar{\alpha}_{t-1}}-\frac{\left(\mathbf{x}_t-\sqrt{\bar{\alpha}_t} \mathbf{x}_0\right)^2}{1-\bar{\alpha}_t}\right)\right) \\
&amp;=\exp \left(-\frac{1}{2}\left(\frac{\mathbf{x}_t^2-2 \sqrt{\alpha_t} \mathbf{x}_t \mathbf{x}_{t-1}+\alpha_t \mathbf{x}_{t-1}^2}{\beta_t}+\frac{\mathbf{x}_{t-1}^2-2 \sqrt{\bar{\alpha}_{t-1}} \mathbf{x}_0 \mathbf{x}_{t-1}+\bar{\alpha}_{t-1} \mathbf{x}_0^2}{1-\bar{\alpha}_{t-1}}-\frac{\left(\mathbf{x}_t-\sqrt{\bar{\alpha}_t} \mathbf{x}_0\right)^2}{1-\bar{\alpha}_t}\right)\right) \\
&amp;=\exp \left(-\frac{1}{2}\left(\left(\frac{\alpha_t}{\beta_t}+\frac{1}{1-\bar{\alpha}_{t-1}}\right) \mathbf{x}_{t-1}^2-\left(\frac{2 \sqrt{\alpha_t}}{\beta_t} \mathbf{x}_t+\frac{2 \sqrt{\bar{\alpha}_{t-1}}}{1-\bar{\alpha}_{t-1}} \mathbf{x}_0\right) \mathbf{x}_{t-1}+C\left(\mathbf{x}_t, \mathbf{x}_0\right)\right)\right)
\end{aligned}
\end{equation}
</p>

<p>å…¶ä¸­å‡½æ•°$C(x_t, x_0)$ä¸$x_{t-1}$æ— å…³ï¼Œæ ¹æ®ä¸Šè¿°å¼å­æˆ‘ä»¬å¯ä»¥å¾—å‡º$q(x_{t-1}|x_t,x_0)$æ»¡è¶³æ­£æ€åˆ†å¸ƒï¼Œå‡å€¼å’Œæ ‡å‡†å·®åˆ†åˆ«ä¸º$\tilde{\mu_t}$å’Œ$\tilde{\beta_t}$ï¼Œè¡¨è¾¾å¼åˆ†åˆ«ä¸º:</p>

<p>
\begin{equation}
\begin{aligned}
\tilde{\beta}_t 
&amp;= 1/(\frac{\alpha_t}{\beta_t} + \frac{1}{1 - \bar{\alpha}_{t-1}}) 
= 1/(\frac{\alpha_t - \bar{\alpha}_t + \beta_t}{\beta_t(1 - \bar{\alpha}_{t-1})})
= \frac{1 - \bar{\alpha}_{t-1}}{1 - \bar{\alpha}_t} \cdot \beta_t \\
\tilde{\boldsymbol{\mu}}_t (\mathbf{x}_t, \mathbf{x}_0)
&amp;= (\frac{\sqrt{\alpha_t}}{\beta_t} \mathbf{x}_t + \frac{\sqrt{\bar{\alpha}_{t-1} }}{1 - \bar{\alpha}_{t-1}} \mathbf{x}_0)/(\frac{\alpha_t}{\beta_t} + \frac{1}{1 - \bar{\alpha}_{t-1}}) \\
&amp;= (\frac{\sqrt{\alpha_t}}{\beta_t} \mathbf{x}_t + \frac{\sqrt{\bar{\alpha}_{t-1} }}{1 - \bar{\alpha}_{t-1}} \mathbf{x}_0) \frac{1 - \bar{\alpha}_{t-1}}{1 - \bar{\alpha}_t} \cdot \beta_t \\
&amp;= \frac{\sqrt{\alpha_t}(1 - \bar{\alpha}_{t-1})}{1 - \bar{\alpha}_t} \mathbf{x}_t + \frac{\sqrt{\bar{\alpha}_{t-1}}\beta_t}{1 - \bar{\alpha}_t} \mathbf{x}_0\\
\end{aligned}
\end{equation}
</p>

<p>äºæ˜¯æœ€ç»ˆå¯ä»¥å¾—åˆ°$q(x_{t-1}|x_t,x_0)$:</p>

<p>
\begin{equation}
q(\mathbf{x}_{t-1} \vert \mathbf{x}_t, \mathbf{x}_0) = \mathcal{N}(\mathbf{x}_{t-1}; \tilde{\boldsymbol{\mu}}(\mathbf{x}_t, \mathbf{x}_0), \tilde{\beta}_t \mathbf{I})
\end{equation}
</p>

<p>åœ¨æ ¹æ®é©¬å°”å¯å¤«é“¾æˆ‘ä»¬æœ‰: $\mathbf{x}_0 = \frac{1}{\sqrt{\bar{\alpha}_t}}(\mathbf{x}_t - \sqrt{1 - \bar{\alpha}_t}\boldsymbol{\epsilon}_t)$ï¼Œæ³¨æ„è¿™é‡Œçš„$\epsilon_t$å¹¶ä¸æ˜¯ä»»æ„çš„ä¸€ä¸ªå™ªå£°ï¼Œè€Œæ˜¯è®©$x_0$å˜æˆ$x_t$çš„å™ªå£°ï¼Œé‚£ä¹ˆ$\tilde{\mu_t}$å¯ä»¥è¡¨ç¤ºä¸º:</p>

<p>
\begin{equation}
\begin{aligned}
\tilde{\boldsymbol{\mu}}_t
&amp;= \frac{\sqrt{\alpha_t}(1 - \bar{\alpha}_{t-1})}{1 - \bar{\alpha}_t} \mathbf{x}_t + \frac{\sqrt{\bar{\alpha}_{t-1}}\beta_t}{1 - \bar{\alpha}_t} \frac{1}{\sqrt{\bar{\alpha}_t}}(\mathbf{x}_t - \sqrt{1 - \bar{\alpha}_t}\boldsymbol{\epsilon}_t) \\
&amp;= \frac{1}{\sqrt{\alpha_t}} \Big( \mathbf{x}_t - \frac{1 - \alpha_t}{\sqrt{1 - \bar{\alpha}_t}} \boldsymbol{\epsilon}_t \Big)
\end{aligned}
\end{equation}
</p>

<h2 id="23-æŸå¤±å‡½æ•°">2.3. æŸå¤±å‡½æ•°</h2>
<p>å’ŒVAEç±»ä¼¼ï¼Œä¹Ÿå¯ä»¥ç”¨Variational Lower Boundæ¥æœ€å¤§è¾¹ç¼˜ä¼¼ç„¶å‡½æ•°$p_\theta(x_0)$:</p>

<p>
\begin{equation}
\begin{aligned}
- \log p_\theta(\mathbf{x}_0) 
&amp;\leq - \log p_\theta(\mathbf{x}_0) + D_\text{KL}(q(\mathbf{x}_{1:T}\vert\mathbf{x}_0) \| p_\theta(\mathbf{x}_{1:T}\vert\mathbf{x}_0) ) \\
&amp;= -\log p_\theta(\mathbf{x}_0) + \mathbb{E}_{\mathbf{x}_{1:T}\sim q(\mathbf{x}_{1:T} \vert \mathbf{x}_0)} \Big[ \log\frac{q(\mathbf{x}_{1:T}\vert\mathbf{x}_0)}{p_\theta(\mathbf{x}_{0:T}) / p_\theta(\mathbf{x}_0)} \Big] \\
&amp;= -\log p_\theta(\mathbf{x}_0) + \mathbb{E}_q \Big[ \log\frac{q(\mathbf{x}_{1:T}\vert\mathbf{x}_0)}{p_\theta(\mathbf{x}_{0:T})} + \log p_\theta(\mathbf{x}_0) \Big] \\
&amp;= \mathbb{E}_q \Big[ \log \frac{q(\mathbf{x}_{1:T}\vert\mathbf{x}_0)}{p_\theta(\mathbf{x}_{0:T})} \Big] \\
\text{Let }L_\text{VLB} 
&amp;= \mathbb{E}_{q(\mathbf{x}_{0:T})} \Big[ \log \frac{q(\mathbf{x}_{1:T}\vert\mathbf{x}_0)}{p_\theta(\mathbf{x}_{0:T})} \Big] \geq - \mathbb{E}_{q(\mathbf{x}_0)} \log p_\theta(\mathbf{x}_0)
\end{aligned}
\end{equation}
</p>

<p>ç”±äºè¿™é‡Œå–äº†-logï¼Œæ‰€ä»¥ç›®æ ‡å˜æˆäº†æœ€å°åŒ–VLBæŸå¤±å‡½æ•°ï¼Œç»è¿‡ä¸€ç³»åˆ—æ¼«é•¿çš„æ¨å¯¼ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°(ä¸­é—´æ­¥éª¤å…¶åå°±æ˜¯ç”¨é©¬å°”ç§‘å¤«é“¾å’Œè´å¶æ–¯å®šç†æŠŠæ¡ä»¶æ¦‚ç‡æ‹†å¼€):</p>

<p>
\begin{equation}
\begin{aligned}
L_\text{VLB} &amp;= L_T + L_{T-1} + \dots + L_0 \\
\text{where } L_T &amp;= D_\text{KL}(q(\mathbf{x}_T \vert \mathbf{x}_0) \parallel p_\theta(\mathbf{x}_T)) \\
L_t &amp;= D_\text{KL}(q(\mathbf{x}_t \vert \mathbf{x}_{t+1}, \mathbf{x}_0) \parallel p_\theta(\mathbf{x}_t \vert\mathbf{x}_{t+1})) \text{ for }1 \leq t \leq T-1 \\
L_0 &amp;= - \log p_\theta(\mathbf{x}_0 \vert \mathbf{x}_1)
\end{aligned}
\end{equation}
</p>

<p>å‚æ•°åŒ–æŸå¤±å‡½æ•°ä¸­çš„$L_t$: åå‘æ‰©æ•£çš„ç›®æ ‡æ˜¯ç”¨ç¥ç»ç½‘ç»œæ¥æ‹ŸåˆåéªŒåˆ†å¸ƒ$p_\theta(x_{t-1} \vert x_t) = N(x_{t-1}; \mu_\theta(x_t, t), \Sigma_\theta(x_t, t))$ï¼Œæ ¹æ®æŸå¤±å‡½æ•°$L_t$å¯çŸ¥ï¼Œåå‘æ‰©æ•£è®­ç»ƒçš„ç›®æ ‡æ˜¯: ç»™å®štå’Œ$x_t$, $\mu_\theta$çš„ç»“æœå’Œ$\tilde{\mu_t}$æ›´æ¥è¿‘ï¼Œå› ä¸ºä»»æ„$x_t$åœ¨ç»™å®š$x_0$çš„æƒ…å†µä¸‹éƒ½å¯ä»¥æ±‚å‡ºï¼Œæˆ‘ä»¬å¯ä»¥å‚æ•°åŒ–é«˜æ–¯å™ªå£°ï¼ŒæŠŠåå‘æ‰©æ•£çš„ç›®æ ‡å˜æˆè®©$\epsilon_t$å’Œ$\epsilon_\theta$æ›´æ¥è¿‘</p>

<p>
\begin{equation}
\begin{aligned}
\boldsymbol{\mu}_\theta(\mathbf{x}_t, t) &amp;= \frac{1}{\sqrt{\alpha_t}} \Big( \mathbf{x}_t - \frac{1 - \alpha_t}{\sqrt{1 - \bar{\alpha}_t}} \boldsymbol{\epsilon}_\theta(\mathbf{x}_t, t) \Big) \\
\end{aligned}
\end{equation}
</p>

<p>æŸå¤±å‡½æ•°$L_t$ä¸º:</p>

<p style="font-size: 20px">
\begin{equation}
\begin{aligned}
L_t 
&amp;= \mathbb{E}_{\mathbf{x}_0, \boldsymbol{\epsilon}} \Big[\frac{1}{2 \| \boldsymbol{\Sigma}_\theta(\mathbf{x}_t, t) \|^2_2} \| \tilde{\boldsymbol{\mu}}_t(\mathbf{x}_t, \mathbf{x}_0) - \boldsymbol{\mu}_\theta(\mathbf{x}_t, t) \|^2 \Big] \\
&amp;= \mathbb{E}_{\mathbf{x}_0, \boldsymbol{\epsilon}} \Big[\frac{1}{2  \|\boldsymbol{\Sigma}_\theta \|^2_2} \| \frac{1}{\sqrt{\alpha_t}} \Big( \mathbf{x}_t - \frac{1 - \alpha_t}{\sqrt{1 - \bar{\alpha}_t}} \boldsymbol{\epsilon}_t \Big) - \frac{1}{\sqrt{\alpha_t}} \Big( \mathbf{x}_t - \frac{1 - \alpha_t}{\sqrt{1 - \bar{\alpha}_t}} \boldsymbol{\boldsymbol{\epsilon}}_\theta(\mathbf{x}_t, t) \Big) \|^2 \Big] \\
&amp;= \mathbb{E}_{\mathbf{x}_0, \boldsymbol{\epsilon}} \Big[\frac{ (1 - \alpha_t)^2 }{2 \alpha_t (1 - \bar{\alpha}_t) \| \boldsymbol{\Sigma}_\theta \|^2_2} \|\boldsymbol{\epsilon}_t - \boldsymbol{\epsilon}_\theta(\mathbf{x}_t, t)\|^2 \Big] \\
&amp;= \mathbb{E}_{\mathbf{x}_0, \boldsymbol{\epsilon}} \Big[\frac{ (1 - \alpha_t)^2 }{2 \alpha_t (1 - \bar{\alpha}_t) \| \boldsymbol{\Sigma}_\theta \|^2_2} \|\boldsymbol{\epsilon}_t - \boldsymbol{\epsilon}_\theta(\sqrt{\bar{\alpha}_t}\mathbf{x}_0 + \sqrt{1 - \bar{\alpha}_t}\boldsymbol{\epsilon}_t, t)\|^2 \Big] 
\end{aligned}
\end{equation}
</p>

<h2 id="24-ddpmä¸­ç»™å‡ºçš„è®­ç»ƒä¸é‡‡æ ·ç”Ÿæˆè¿‡ç¨‹">2.4. DDPMä¸­ç»™å‡ºçš„è®­ç»ƒä¸é‡‡æ ·(ç”Ÿæˆ)è¿‡ç¨‹</h2>
<center><img src="../assets/img/posts/20221012/4.jpg" /></center>

<p>è®­ç»ƒè¿‡ç¨‹:</p>
<ol>
  <li>é‡‡æ ·ä¸€ä¸ª$x_0$</li>
  <li>ä»»é€‰ä¸€ä¸ªæ—¶é—´t</li>
  <li>éšæœºé‡‡æ ·ä¸€ä¸ªé«˜æ–¯å™ªå£°$\epsilon$</li>
  <li>è®¡ç®—æŸå¤±å‡½æ•°çš„æ¢¯åº¦ï¼Œæ›´æ–°å‚æ•°$\theta$</li>
</ol>

<p>é‡‡æ ·è¿‡ç¨‹:</p>
<ol>
  <li>é‡‡æ ·ä¸€ä¸ªé«˜æ–¯å™ªå£°$x_T$</li>
  <li>ä»æ—¶é—´Tå¼€å§‹ï¼Œæ¯ä¸€æ­¥é‡‡æ ·ä¸€ä¸ªé«˜æ–¯å™ªå£°zï¼Œåˆ©ç”¨é‡å‚æ•°åŒ–ï¼Œå¾—åˆ°ä¸Šä¸€æ­¥çš„$x_{t-1}$ï¼Œé‡å¤Tæ¬¡ï¼Œæœ€ç»ˆå¾—åˆ°ç”Ÿæˆçš„$x_0$</li>
</ol>

<p>æ³¨æ„è¿™é‡Œè¿˜æ²¡æœ‰ç»™å‡º$\epsilon_\theta(x_t, t)$çš„ç½‘ç»œç»“æ„ï¼ŒDDPMä½¿ç”¨U-Netä½œä¸ºå…¶ç½‘ç»œç»“æ„(åé¢ä¼šå…·ä½“å±•å¼€)</p>

<h2 id="25-å°ç»“">2.5. å°ç»“</h2>
<p>ç®€å•æ¥è¯´ï¼Œæ‰©æ•£æ¨¡å‹çš„å‰å‘æ‰©æ•£è¿‡ç¨‹éƒ½æ˜¯å®šä¹‰å¥½çš„é©¬å°”å¯å¤«é“¾ï¼Œæ¯ä¸€æ­¥éƒ½éœ€è¦ä½¿ç”¨é‡å‚æ•°åŒ–æŠ€å·§æ¥æ·»åŠ å™ªå£°ï¼Œè¿™é‡Œæ¯ä¸€æ­¥çš„åéªŒåˆ†å¸ƒçš„å‚æ•°éƒ½æ˜¯é¢„å®šä¹‰å¥½çš„ã€‚åå‘æ‰©æ•£è¿‡ç¨‹å°±æ˜¯ç”¨å™ªå£°ç”ŸæˆåŸå§‹å›¾ç‰‡çš„è¿‡ç¨‹ï¼Œå’ŒVAEç±»ä¼¼ï¼Œç”¨åˆ†å¸ƒ$p_\theta(x_{t-1}|x_t)$æ¥æ‹ŸåˆçœŸå®çš„åéªŒåˆ†å¸ƒ$q(x_{t-1}|x_t)$ï¼Œæ‰€ä»¥ç”Ÿæˆè¿‡ç¨‹æœ€é‡è¦çš„å°±æ˜¯è®­ç»ƒå‡ºåˆé€‚çš„åˆ†å¸ƒæ¥æ‹Ÿåˆï¼Œé€šè¿‡VLBå’Œé‡å‚æ•°åŒ–çš„æŠ€å·§ï¼Œæœ€ç»ˆå¯ä»¥æŠŠè®­ç»ƒè¿‡ç¨‹çœ‹æˆç»™ä¸€ä¸ªé«˜æ–¯å™ªå£°ï¼Œæ‹Ÿåˆæˆå‰å‘æ‰©æ•£çš„å™ªå£°ã€‚è¿™é‡Œçš„ç½‘ç»œç»“æ„ä¸€èˆ¬ä½¿ç”¨çš„æ˜¯U-Net</p>

<h1 id="3-ä¸€äº›æŠ€å·§å’Œä¸»è¦ç½‘ç»œç»“æ„">3. ä¸€äº›æŠ€å·§å’Œä¸»è¦ç½‘ç»œç»“æ„</h1>
<h2 id="31-beta_tå’Œsigma_thetaçš„å–å€¼">3.1. $\beta_t$å’Œ$\Sigma_\theta$çš„å–å€¼</h2>
<p>å…³äº$\beta_t$çš„å–å€¼ï¼ŒDDPMçš„åšæ³•æ˜¯$\beta_1=10^{-4}$åˆ°$\beta_T=0.02$çº¿æ€§å–å€¼ï¼Œè¿™æ ·çš„æ‰©æ•£æ¨¡å‹å–å¾—çš„æ•ˆæœä¸ç®—æœ€å¥½ï¼Œ<a href="https://arxiv.org/abs/2102.09672" target="_blank">Improved DDPM</a>æå‡ºäº†ä¸€ç§æ–°çš„å–å€¼æ–¹æ³•:</p>

<p>
\begin{equation}
\beta_t = \text{clip}(1-\frac{\bar{\alpha}_t}{\bar{\alpha}_{t-1}}, 0.999) \quad\bar{\alpha}_t = \frac{f(t)}{f(0)}\quad\text{where }f(t)=\cos\Big(\frac{t/T+s}{1+s}\cdot\frac{\pi}{2}\Big)
\end{equation}
</p>

<p>å…³äº$\Sigma_\theta$çš„å–å€¼æ–¹æ³•ï¼ŒDDPMé‡‡ç”¨å›ºå®šçš„$\Sigma_\theta$(ä¸å­¦ä¹ )ï¼Œå¯ä»¥å–$\beta_t$æˆ–è€…$\tilde{\beta_t}=\frac{1 - \bar{\alpha_{t-1}}}{1 - \bar{\alpha_t}} \cdot \beta_t$ï¼ŒImproved DDPMé‡‡ç”¨å¯å­¦ä¹ çš„$\Sigma_\theta$å‚æ•°ï¼Œåˆ©ç”¨çº¿æ€§æ’å€¼çš„æ–¹æ³•:</p>

<p>
\begin{equation}
\boldsymbol{\Sigma}_\theta(\mathbf{x}_t, t) = \exp(\mathbf{v} \log \beta_t + (1-\mathbf{v}) \log \tilde{\beta}_t)
\end{equation}
</p>

<p>ç”±äºæŸå¤±å‡½æ•°ä¸­æ²¡æœ‰å…³äº$\Sigma_\theta$çš„æ¢¯åº¦ï¼Œæ‰€ä»¥éœ€è¦å¯¹æŸå¤±å‡½æ•°è¿›è¡Œä¸€ç‚¹æ›´æ”¹</p>

<h2 id="32-åŠ é€Ÿæ‰©æ•£æ¨¡å‹é‡‡æ ·çš„æŠ€å·§">3.2. åŠ é€Ÿæ‰©æ•£æ¨¡å‹é‡‡æ ·çš„æŠ€å·§</h2>
<p>DDPMçš„ä½œè€…å¯¹æ¯”äº†æ‰©æ•£æ¨¡å‹å’Œå…¶ä»–ç”Ÿæˆæ¨¡å‹çš„ç”Ÿæˆé€Ÿåº¦ï¼Œå‘ç°DDPMçš„ç”Ÿæˆé€Ÿåº¦è¿œå°äºå…¶ä»–ç”Ÿæˆæ¨¡å‹ï¼Œæœ‰ä¸€äº›åŠ é€Ÿæ¨¡å‹é‡‡æ ·çš„æŠ€å·§:</p>
<ol>
  <li>ç¼©çŸ­é‡‡æ ·æ­¥éª¤ï¼Œæ¯”å¦‚æ¯éš”T/Sæ­¥æ‰é‡‡æ ·ä¸€æ¬¡</li>
  <li><a href="https://arxiv.org/abs/2010.02502" target="_blank">DDIM</a>è®ºæ–‡é‡Œæå‡ºçš„æŠ€å·§ï¼Œåœ¨é‡‡æ ·è¿‡ç¨‹ä¸­åªéœ€è¦é‡‡æ ·ä¸€ä¸ªå­é›†çš„æ­¥éª¤ä¾¿å¯åšç”Ÿæˆ</li>
  <li><a href="https://arxiv.org/abs/2112.10752" target="_blank">Latent Diffusion Model</a>è®ºæ–‡æå‡ºè®©æ‰©æ•£è¿‡ç¨‹åœ¨éšç©ºé—´ä¸­è¿›è¡Œï¼Œè€Œä¸æ˜¯åœ¨åƒç´ ç©ºé—´ä¸­è¿›è¡Œï¼Œè¿™æ ·å¯ä»¥è®©è®­ç»ƒä»£ä»·æ›´å°ï¼Œæ¨æ–­è¿‡ç¨‹æ›´å¿«ï¼Œåç»­ä¼šæ•´ç†LDMè®ºæ–‡</li>
</ol>

<h2 id="33-u-net">3.3. U-Net</h2>
<p>å¾ˆå¤šæ‰©æ•£æ¨¡å‹çš„å™ªå£°ç½‘ç»œç»“æ„éƒ½æ˜¯åŸºäº<a href="https://arxiv.org/pdf/1505.04597.pdf" target="_blank">U-Net</a>ï¼ŒU-Netçš„ç½‘ç»œç»“æ„å¦‚ä¸‹å›¾:</p>

<center><img src="../assets/img/posts/20221012/5.jpg" /></center>

<p>æ¨¡å‹å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œå·¦è¾¹ç”¨äºç‰¹å¾çš„æŠ½å–ï¼Œå³è¾¹éƒ¨åˆ†ç”¨äºä¸Šé‡‡æ ·ï¼Œç”±äºç½‘ç»œç»“æ„é…·ä¼¼å­—æ¯Uè€Œå¾—åã€‚U-Netç½‘ç»œç»“æ„åˆå¯ä»¥çœ‹æˆAutoEncoderçš„ç»“æ„ï¼Œå®ƒçš„bottleneckå°±æ˜¯ä¸­é—´çš„ä½çº¬åº¦ç‰¹å¾è¡¨ç¤ºï¼ŒU-Netè¦ä¿è¯è¾“å‡ºçš„å™ªå£°å’Œè¾“å…¥çš„å™ªå£°æœ‰ç›¸åŒçš„ç»´åº¦ï¼Œæ˜¯ä¸€ä¸ªè‡ªå›å½’æ¨¡å‹ã€‚DDPMä½¿ç”¨çš„æ˜¯PixelCNN++çš„backboneï¼Œä¹Ÿå°±æ˜¯åŸºäºWide Resnetçš„U-Netï¼Œä¹Ÿå°±æ˜¯è¯´encoderå’Œdecoderä¹‹é—´æ˜¯æ®‹å·®è¿æ¥ï¼Œè¾“å…¥$x_t$è¿”å›å™ªå£°(æ®‹å·®æ€æƒ³)</p>

<h1 id="4-æ¡ä»¶ç”Ÿæˆ">4. æ¡ä»¶ç”Ÿæˆ</h1>
<p>æ¡ä»¶ç”Ÿæˆå°±æ˜¯conditioned generationï¼Œé€šè¿‡è¾“å…¥é¢å¤–çš„conditioning informationæ¥ç”Ÿæˆå›¾ç‰‡ï¼Œæ¯”å¦‚ä¸€æ®µæç¤ºè¯æˆ–è€…ç”Ÿæˆå›¾ç‰‡çš„ç±»åˆ«</p>

<h2 id="41-classifier-guided-diffusion">4.1. Classifier Guided Diffusion</h2>
<p>åšå®¢ä¸Šè®²è§£çš„å…³äºclassifier guidanceçš„éƒ¨åˆ†ä¸å¤ªè¯¦å°½ï¼Œäºæ˜¯æˆ‘å»ç¿»çœ‹äº†Classifier Guidanceçš„è®ºæ–‡<a href="https://arxiv.org/abs/2105.05233" target="_blank">Diffusion Models Beat GANs</a>:</p>

<p>classifier guidanceçš„æ€è·¯æ¥æºäºGANæ¨¡å‹çš„æ¡ä»¶ç”Ÿæˆï¼Œå°†è¿™ç§æ¡ä»¶ç”Ÿæˆåº”ç”¨äºæ‰©æ•£æ¨¡å‹åï¼Œå‘ç°æ•ˆæœéå¸¸å¥½ã€‚ä½œè€…æå‡ºå¯ä»¥è®­ç»ƒä¸€ä¸ªåˆ†ç±»å™¨$p_\phi(y|x_t, t)$ï¼Œç„¶åæŠŠ$\nabla_{x_t} \log p_\phi\left(y \mid x_t, t\right)$çš„åŠ åˆ°æ€»çš„æ¢¯åº¦å…¬å¼é‡Œé¢ï¼Œæ¥æŒ‡å¯¼æ‰©æ•£æ¨¡å‹<strong>é‡‡æ ·çš„è¿‡ç¨‹</strong>åå‘äºç”Ÿæˆç±»åˆ«ä¸ºyçš„å›¾ç‰‡</p>

<p>æ²¡æœ‰classifier guidanceä¹‹å‰çš„åå‘æ‰©æ•£åˆ†å¸ƒå‡½æ•°ä¸º: $p_\theta(x_t|x_{t+1})$ï¼Œä½†æ˜¯æœ‰äº†classifier guidanceä¹‹åï¼Œåå‘æ‰©æ•£çš„åéªŒåˆ†å¸ƒå‡½æ•°å˜æˆäº†:</p>

<p>
\begin{equation}
p_{\theta, \phi}(x_t|x_{t+1}, y) = Zp_\theta(x_t|x_{t+1})p_\phi(y|x_t)
\end{equation}
</p>

<p>å…¶ä¸­Zæ˜¯æ­£åˆ™åŒ–çš„å¸¸æ•°ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åŒ–ç®€ä¸Šé¢è¿™ä¸ªå…¬å¼ï¼Œé¦–å…ˆæˆ‘ä»¬çŸ¥é“$p_\theta(x_t|x_{t+1})$æœ¬è´¨ä¸Šå°±æ˜¯æ­£æ€åˆ†å¸ƒ:</p>

<p>
\begin{equation}
p_\theta(x_t|x_{t+1})=\mathcal{N}(\mu, \Sigma)
\end{equation}
</p>

<p>ç„¶åæˆ‘ä»¬å¯¹$log_\phi p(y|x_t)$åœ¨$x=\mu$å¤„è¿›è¡Œæ³°å‹’å±•å¼€:</p>

<p>
\begin{equation}
\begin{aligned}
\log p_\phi(y \mid x_t) &amp; \approx log p_\phi (y \mid x_t) \mid _{x_t=\mu}+(x_t-\mu)\nabla_{x_t}logp_\phi(y \mid x_t)\mid _{x_t=\mu} \\
&amp;=(x_t-\mu)g+C_1\\
\end{aligned}
\end{equation}
</p>

<p>è¿™é‡Œ$g=\nabla_{x_t}logp_\phi(y \mid x_t)\mid _{x_t=\mu}$</p>

<p style="font-size: 18px">
\begin{equation}
\begin{aligned}
\log \left(p_\theta\left(x_t \mid x_{t+1}\right) p_\phi\left(y \mid x_t\right)\right) &amp; \approx-\frac{1}{2}\left(x_t-\mu\right)^T \Sigma^{-1}\left(x_t-\mu\right)+\left(x_t-\mu\right) g+C_2 \\
&amp;=-\frac{1}{2}\left(x_t-\mu-\Sigma g\right)^T \Sigma^{-1}\left(x_t-\mu-\Sigma g\right)+\frac{1}{2} g^T \Sigma g+C_2 \\
&amp;=-\frac{1}{2}\left(x_t-\mu-\Sigma g\right)^T \Sigma^{-1}\left(x_t-\mu-\Sigma g\right)+C_3 \\
&amp;=\log p(z)+C_4, z \sim \mathcal{N}(\mu+\Sigma g, \Sigma)
\end{aligned}
\end{equation}
</p>

<p>é‚£ä¹ˆåå‘æ‰©æ•£è¿‡ç¨‹å°±å¯ä»¥çœ‹æˆå‡å€¼ä¸º$\mu+\Sigma g$ï¼Œæ–¹å·®ä¸º$\Sigma$çš„æ­£æ€åˆ†å¸ƒï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ‰ä»¥ä¸‹é‡‡æ ·ç®—æ³•:</p>

<center><img src="../assets/img/posts/20221012/6.jpg" /></center>

<p>å¦ä¸€ç§æ€è·¯æ˜¯ä¿®æ”¹æ­£æ€åˆ†å¸ƒä¸­çš„å™ªå£°å‡½æ•°ï¼ŒåŸæœ¬çš„æ¢¯åº¦ä¸º:</p>

<p>
\begin{equation}
\nabla _{x_t} log p_\theta (x_t) = - \frac{1}{\sqrt{1-\overline{\alpha_t}}} \epsilon_\theta (x_t)
\end{equation}
</p>

<p>ä¿®æ”¹åå‘æ‰©æ•£å‡½æ•°åçš„æ¢¯åº¦ä¸º:</p>

<p>
\begin{equation}
\begin{aligned}
\nabla _{x_t} log (p_\theta (x_t) p_\phi (y \mid x_t))  &amp;= \nabla _{x_t} log p_\theta (x_t) + \nabla _{x_t} log p_\phi (y \mid x_t) \\
&amp;= - \frac{1}{\sqrt{1-\overline{\alpha_t}}} \epsilon_\theta (x_t) + \nabla _{x_t} log p_\phi (y \mid x_t)
\end{aligned}
\end{equation}
</p>

<p>é‚£ä¹ˆæ ¹æ®æ¢¯åº¦ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæ–°çš„å™ªå£°é¢„æµ‹å‡½æ•°$\hat{\epsilon}$:</p>

<p>
\begin{equation}
\hat{\epsilon(x_t)} := \epsilon_\theta(x_t) - \sqrt{1-\overline{\alpha_t}} \nabla _{x_t} log p_\phi(y \mid x_t)
\end{equation}
</p>

<p>è¯¥æ–¹æ³•å¯¹åº”çš„ç®—æ³•ä¸º:</p>

<center><img src="../assets/img/posts/20221012/7.jpg" /></center>

<h2 id="42-classifier-free-guidance">4.2. Classifier-Free Guidance</h2>
<p>ä¸Šä¸€å°èŠ‚æåˆ°çš„classifier guidanceçš„æŠ€å·§æ˜¯éœ€è¦å•ç‹¬ä½¿ç”¨ä¸€ä¸ªåˆ†ç±»å™¨(å‚ä¸è®­ç»ƒæˆ–è€…ä¸å‚ä¸è®­ç»ƒçš„æƒ…å†µéƒ½æœ‰)æ¥è·å¾—$x_t$çš„ç±»åˆ«ï¼Œæ ¹æ®ä¸åŒçš„classå¯ä»¥ä½¿ç”¨ä¸åŒçš„åˆ†ç±»å™¨ï¼Œæ¯”å¦‚resnetå¯ä»¥è¿›è¡Œå›¾ç‰‡ç±»åˆ«çš„guidanceï¼ŒCLIPå¯ä»¥è¿›è¡Œæ–‡æœ¬çš„guidanceç­‰ç­‰ã€‚å¦‚æœæˆ‘ä»¬æ²¡æœ‰è¿™ä¸ªå•ç‹¬çš„åˆ†ç±»å™¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨classifier-free guidanceçš„æŠ€å·§æ¥å®ç°æ¡ä»¶ç”Ÿæˆï¼ŒåŒæ ·åœ°ï¼Œä¸ºäº†æ›´è¯¦å°½åœ°äº†è§£è¿™ä¸ªæŠ€å·§ï¼Œæˆ‘å»ç¿»çœ‹äº†<a href="https://arxiv.org/abs/2112.10741" target="_blank">GLIDE</a>è®ºæ–‡ä¸­å…³äºclassifier-free guidanceçš„ä»‹ç»</p>

<p>classifier-free guidanceå¹¶ä¸éœ€è¦æ¨¡å‹å»å•ç‹¬ç»™å‡ºä¸€ä¸ªåˆ†ç±»å™¨ï¼Œè€Œæ˜¯å°†æ¡ä»¶ç”Ÿæˆä¸éæ¡ä»¶ç”Ÿæˆéƒ½ç”¨åŒä¸€ä¸ªå‡½æ•°è¡¨ç¤ºï¼Œå³$\epsilon(x_t\mid y)$ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›è¿™ä¸ªå‡½æ•°è¡¨ç¤ºéæ¡ä»¶ç”Ÿæˆï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å°†yæ›¿æ¢æˆç©ºé›†å³å¯ï¼Œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä»¥ç›¸åŒçš„æ¦‚ç‡éšæœºæ›¿æ¢yä¸ºç©ºé›†ã€‚é‡‡æ ·æ—¶ï¼Œåå‘æ‰©æ•£å‡½æ•°ä¸º$\epsilon_\theta(x_t \mid y)$å’Œ$\epsilon_\theta(x_t \mid \emptyset)$çš„çº¿æ€§æ’å€¼:</p>

<p>
\begin{equation}
\hat{\epsilon_\theta}(x_t \mid y)=\epsilon_\theta(x_t\mid \emptyset) + s \cdot (\epsilon_\theta(x_t\mid y)-\epsilon_\theta(x_t\mid \emptyset))
\end{equation}
</p>

<p>å¼å­ä¸­çš„sæ˜¯guidance scaleï¼Œsè¶Šå¤§ä»£è¡¨ç”Ÿæˆçš„å›¾ç‰‡è¶Šé è¿‘yï¼Œguidance-freeçš„æŠ€å·§å‡ºç°åï¼Œå¤§å®¶å‘ç°å®ƒçš„æ•ˆæœéå¸¸å¥½ï¼Œäºæ˜¯åç»­çš„æ¨¡å‹åŸºæœ¬ä¸Šéƒ½è¿ç”¨äº†è¯¥æŠ€å·§ï¼Œæ¯”å¦‚GLIDEã€DALLE2ã€Imagen</p>

<h2 id="43-scale-up-generation-resolution-and-quality">4.3. Scale up Generation Resolution and Quality</h2>
<p>ä¸ºäº†ç”Ÿæˆæ›´é«˜è´¨é‡å’Œæ›´é«˜åˆ†è¾¨ç‡çš„å›¾ç‰‡ï¼Œå¯ä»¥å°†æ‰©æ•£æ¨¡å‹ä¸è¶…åˆ†è¾¨ç‡çš„æŠ€æœ¯ç›¸ç»“åˆï¼Œè®ºæ–‡<a href="https://arxiv.org/abs/2106.15282" target="_blank">Cascaded Diffusion Model</a>ä¸­æå‡ºç”¨å±‚çº§å¼çš„æ‰©æ•£æ¨¡å‹æ¥åšå›¾ç‰‡çš„è¶…åˆ†è¾¨ç‡ç”Ÿæˆï¼Œæ¨¡å‹çš„ç»“æ„å¦‚ä¸‹å›¾:</p>

<center><img src="../assets/img/posts/20221012/8.jpg" /></center>

<p>æ¨¡å‹ç”±ä¸‰ä¸ªå­æ¨¡å‹ç»„æˆï¼Œåˆ†åˆ«æ˜¯ä¸€ä¸ªåŸºç¡€çš„æ‰©æ•£æ¨¡å‹å’Œä¸¤ä¸ªè¶…åˆ†è¾¨ç‡æ‰©æ•£æ¨¡å‹ï¼Œæ³¨æ„è¿™é‡Œçš„æ¯ä¸ªå­æ¨¡å‹éƒ½éœ€è¦è¾“å…¥ç±»åˆ«ï¼Œè¶…åˆ†è¾¨ç‡å­æ¨¡å‹è¿˜éœ€è¦è¾“å…¥ä¸Šä¸€ä¸ªå­æ¨¡å‹çš„ä½åˆ†è¾¨ç‡ç»“æœï¼Œè¿™äº›å­æ¨¡å‹éƒ½æ˜¯conditionalçš„ã€‚è¶…åˆ†è¾¨ç‡æ‰©æ•£æ¨¡å‹ä¸æ™®é€šçš„æ‰©æ•£æ¨¡å‹çš„åŒºåˆ«æ˜¯æŸå¤±å‡½æ•°å’Œåå‘æ‰©æ•£å‡½æ•°ä¸åŒï¼Œå…·ä½“æ¥è¯´å°±æ˜¯U-Netçš„ç»“æ„ä¸åŒï¼Œè¶…åˆ†è¾¨ç‡çš„U-Netçš„è¾“å‡ºç»´åº¦æ¯”è¾“å…¥ç»´åº¦è¦å¤§ï¼Œè€Œä¸”è¾“å…¥ä¸ºä½åˆ†è¾¨ç‡çš„å›¾ç‰‡ã€é«˜åˆ†è¾¨ç‡çš„å›¾ç‰‡ã€ç±»åˆ«:</p>

<center><img src="../assets/img/posts/20221012/9.jpg" /></center>

<p>ä¸€ä¸ªtwo-stageçš„cascadedæ¨¡å‹çš„è®­ç»ƒç®—æ³•ä¸º:</p>

<center><img src="../assets/img/posts/20221012/9.jpg" /></center>
:ET