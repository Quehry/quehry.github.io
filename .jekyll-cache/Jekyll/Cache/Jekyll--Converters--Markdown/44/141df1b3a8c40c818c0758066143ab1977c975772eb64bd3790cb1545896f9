I"Ñ <!-- TOC -->

<ul>
  <li><a href="#1-æ‰©æ•£æ¨¡å‹ç®€ä»‹">1. æ‰©æ•£æ¨¡å‹ç®€ä»‹</a></li>
  <li><a href="#2-æ¨¡å‹">2. æ¨¡å‹</a>
    <ul>
      <li><a href="#21-å‰å‘æ‰©æ•£">2.1. å‰å‘æ‰©æ•£</a></li>
      <li><a href="#22-åå‘æ‰©æ•£è¿‡ç¨‹">2.2. åå‘æ‰©æ•£è¿‡ç¨‹</a></li>
    </ul>
  </li>
</ul>

<!-- /TOC -->

<h1 id="1-æ‰©æ•£æ¨¡å‹ç®€ä»‹">1. æ‰©æ•£æ¨¡å‹ç®€ä»‹</h1>
<p>æ‰©æ•£æ¨¡å‹(Diffusion Model)æ˜¯æ·±åº¦ç”Ÿæˆæ¨¡å‹ä¸­çš„SOTAï¼Œç›¸æ¯”äºGANã€VAEã€Flow-basedè¿™äº›ç”Ÿæˆæ¨¡å‹è€Œè¨€ï¼Œæ‰©æ•£æ¨¡å‹å¯ä»¥å–å¾—æ›´å¥½çš„æ•ˆæœã€‚æ‰©æ•£æ¨¡å‹å—éå¹³è¡¡çƒ­åŠ›å­¦å¯å‘ï¼Œå®ƒå®šä¹‰äº†ä¸€æ¡å¤šæ—¶é—´æ­¥çš„é©¬å°”å¯å¤«é“¾æ¥é€æ­¥ç»™å›¾ç‰‡æ·»åŠ å™ªå£°ï¼Œå¦‚æœæ—¶é—´æ­¥å¤Ÿå¤§ï¼Œæœ€ç»ˆå›¾ç‰‡ä¼šå˜æˆçº¯å™ªå£°ï¼Œæ‰©æ•£æ¨¡å‹çš„ç›®çš„æ˜¯å­¦ä¹ åå‘çš„æ‰©æ•£è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¾“å…¥éšæœºå™ªå£°ï¼Œèƒ½è¿”å›ä¸€å¼ å›¾ç‰‡ï¼Œç›¸æ¯”äºä¹‹å‰æåˆ°çš„å„ç§ç”Ÿæˆæ¨¡å‹è€Œè¨€ï¼Œæ‰©æ•£æ¨¡å‹å…·æœ‰ç›¸å¯¹å›ºå®šçš„å­¦ä¹ æ­¥éª¤ï¼ŒåŒæ—¶éšå˜é‡ç»´åº¦æ›´é«˜(å’Œè¾“å…¥æ•°æ®åŒæ ·çš„ç»´åº¦)</p>

<center><img src="../assets/img/posts/20221012/2.jpg" /></center>

<p>æ‰©æ•£æ¨¡å‹çš„æ—©åœ¨2015å¹´ä¾¿æå‡ºäº†(<a href="https://arxiv.org/abs/1503.03585" target="_blank">è®ºæ–‡é“¾æ¥</a>)ï¼Œä½†åœ¨å½“æ—¶æ²¡æœ‰å¼•èµ·å¹¿æ³›çš„å…³æ³¨ï¼Œç›´åˆ°2019å¹´<a href="https://arxiv.org/abs/1907.05600" target="_blank">NCSN</a>å’Œ2020å¹´<a href="https://arxiv.org/abs/2006.11239" target="_blank">DDPM</a>çš„å‡ºç°æ‰å°†æ‰©æ•£æ¨¡å‹å¼•å…¥äº†æ–°é«˜åº¦ï¼Œ2022å¹´ç«çˆ†çš„text2imageæ¨¡å‹GLIDEã€DALLE2ã€Latent Diffusionã€Imagençš„ç›¸ç»§æå‡ºï¼Œè®©æ‰©æ•£æ¨¡å‹ç«å‡ºäº†åœˆï¼Œè¿™ç¯‡åšå®¢å°†å¯¹æ‰©æ•£æ¨¡å‹çš„å‰å‘è®¡ç®—ã€åå‘è®­ç»ƒã€è®­ç»ƒã€ç”Ÿæˆæ­¥éª¤åŠå…¶æ•°å­¦åŸç†åšè¯¦ç»†çš„æ•´ç†ï¼Œä¼šåˆ—å‡ºå¾ˆå¤šæ•°å­¦å…¬å¼ï¼ŒåŒæ—¶è¯¥åšå®¢ä¹Ÿå‚è€ƒäº†å¾ˆå¤šç›¸å…³èµ„æ–™ï¼Œè¿™é‡Œæˆ‘ä¸€å¹¶åˆ—å‡º</p>

<ul>
  <li><a href="https://lilianweng.github.io/posts/2021-07-11-diffusion-models/" target="_blank">Lil blog, ä¸€ç¯‡æ•´ç†ç›¸å½“è¯¦å°½çš„åšå®¢ï¼Œä¹Ÿæ˜¯æˆ‘ä¸»è¦çš„å‚è€ƒå¯¹è±¡</a></li>
  <li><a href="https://huggingface.co/blog/annotated-diffusion" target="_blank">huggingfaceçš„ä¸€ç¯‡è§£é‡Šç®€å•æ˜äº†çš„åšå®¢</a></li>
  <li><a href="https://zhuanlan.zhihu.com/p/525106459" target="_blank">çŸ¥ä¹ä¸Šä¸€ç¯‡ä¸­æ–‡åšå®¢</a></li>
  <li><a href="https://arxiv.org/abs/2006.11239" target="_blank">DDPM</a></li>
  <li><a href="https://arxiv.org/abs/2209.00796" target="_blank">ä¸€ç¯‡ç»¼è¿°</a></li>
</ul>

<h1 id="2-æ¨¡å‹">2. æ¨¡å‹</h1>
<h2 id="21-å‰å‘æ‰©æ•£">2.1. å‰å‘æ‰©æ•£</h2>
<p>ä»åŸå§‹æ•°æ®åˆ†å¸ƒä¸­é‡‡æ ·$x_0$, å‡è®¾$x_0\sim q(x)$ï¼Œå‰å‘æ‰©æ•£è¿‡ç¨‹å°±æ˜¯åœ¨æ¯ä¸€ä¸ªæ—¶é—´æ­¥éƒ½åŠ ä¸Šä¸€ä¸ªé«˜æ–¯å™ªå£°ï¼Œè¿™æ ·å°±å¯ä»¥ä»æœ€åˆçš„$x_0$ç”Ÿæˆé•¿åº¦ä¸ºTçš„å™ªå£°åºåˆ—$x_1, x_2, x_3,â€¦, x_T$ï¼Œæ¯ä¸€æ­¥éƒ½ç”¨variance schedule$\beta_t$æ§åˆ¶ï¼Œå…¶ä¸­$\beta_t\in (0, 1)$ï¼Œæ¯ä¸€æ­¥çš„åéªŒåˆ†å¸ƒ(é¢„å®šä¹‰å¥½çš„)ä¸º:</p>

<p>
\begin{equation}
q(\mathbf{x}_t \vert \mathbf{x}_{t-1}) = \mathcal{N}(\mathbf{x}_t; \sqrt{1 - \beta_t} \mathbf{x}_{t-1}, \beta_t\mathbf{I}) \quad
q(\mathbf{x}_{1:T} \vert \mathbf{x}_0) = \prod^T_{t=1} q(\mathbf{x}_t \vert \mathbf{x}_{t-1})
\end{equation}
</p>

<p>è¿™ä¸ªå‰å‘ä¼ æ’­çš„è¿‡ç¨‹ä¸­æœ‰ä¸€ä¸ªéå¸¸å¥½çš„æ€§è´¨ï¼Œå°±æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨ä»»æ„æ—¶é—´æ­¥é‡‡æ ·å¾—åˆ°$x_t$ï¼Œä¸ºäº†å®ç°è¿™ä¸ªæŠ€å·§ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°reparameterizationæŠ€å·§(è¯¥æŠ€å·§ä¹Ÿåœ¨VAEä¸­å‡ºç°è¿‡)ï¼Œé‡å‚æ•°åŒ–æŠ€å·§çš„æœ¬è´¨å°±æ˜¯å°†éšæœºé‡‡æ ·çš„zé€šè¿‡å¼•å…¥é«˜æ–¯å™ªå£°$\epsilon$å˜æˆç¡®å®šæ€§çš„zï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„$x_t$å¯ä»¥è¡¨ç¤ºä¸º$x_t=\sqrt{1-\beta_t}x_{t-1}+\sqrt{\beta_t}\epsilon$ï¼Œè¿™æ ·æœ‰åˆ©äºæ¢¯åº¦çš„é€†ä¼ æ’­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ¨å‡ºä»¥ä¸‹å…¬å¼:</p>

<p>
\begin{equation}
\begin{aligned}
\mathbf{x}_t 
&amp;= \sqrt{\alpha_t}\mathbf{x}_{t-1} + \sqrt{1 - \alpha_t}\boldsymbol{\epsilon}_{t-1} \\
&amp;= \sqrt{\alpha_t \alpha_{t-1}} \mathbf{x}_{t-2} + \sqrt{1 - \alpha_t \alpha_{t-1}} \bar{\boldsymbol{\epsilon}}_{t-2} \\
&amp;= \dots \\
&amp;= \sqrt{\bar{\alpha}_t}\mathbf{x}_0 + \sqrt{1 - \bar{\alpha}_t}\boldsymbol{\epsilon} \\
q(\mathbf{x}_t \vert \mathbf{x}_0) &amp;= \mathcal{N}(\mathbf{x}_t; \sqrt{\bar{\alpha}_t} \mathbf{x}_0, (1 - \bar{\alpha}_t)\mathbf{I})
\end{aligned}
\end{equation}
</p>

<p>å…¶ä¸­$\epsilon_t$éƒ½æ˜¯å‡å€¼ä¸º0ï¼Œæ–¹å·®ä¸º1çš„é«˜æ–¯å™ªå£°ï¼Œ$\alpha_t=1-\beta_t$, $\bar{\alpha_t}=\prod_{i=1}^t\alpha_i$, æ³¨:ä¸¤ä¸ªå‡å€¼ç›¸åŒé«˜æ–¯å™ªå£°å¯ä»¥åˆå¹¶æˆä¸€ä¸ªé«˜æ–¯å™ªå£°ï¼Œæ–¹å·®ä¸ºä¹‹å‰æ–¹å·®çš„å¹³æ–¹å’Œå¼€æ ¹å·ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œ$\beta_1&lt;\beta_2&lt;â€¦&lt;\beta_T$</p>

<h2 id="22-åå‘æ‰©æ•£è¿‡ç¨‹">2.2. åå‘æ‰©æ•£è¿‡ç¨‹</h2>

<center><img src="../assets/img/posts/20221012/3.jpg" /></center>

<p>å¦‚æœæˆ‘ä»¬å¯ä»¥å°†å‰å‘ä¼ æ’­çš„è¿‡ç¨‹åå‘ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è·å¾—åéªŒåˆ†å¸ƒ$q(x_{t-1}|x_{t})$ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨é©¬å°”ç§‘å¤«é“¾çš„æ€§è´¨ï¼Œè¾“å…¥é«˜æ–¯å™ªå£°ï¼Œç„¶åè·å¾—ç”Ÿæˆçš„ç…§ç‰‡ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬æ— æ³•é«˜æ•ˆåœ°å¾—åˆ°$q(x_{t-1}|x_{t})$ï¼Œäºæ˜¯æˆ‘ä»¬å¸Œæœ›å­¦ä¹ å‡ºåˆ†å¸ƒ$p_\theta$æ¥æ¨¡æ‹ŸåéªŒåˆ†å¸ƒ$q(x_{t-1}|x_{t})$ï¼Œç”±äºå‰å‘æ‰©æ•£çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬å‡è®¾åéªŒåˆ†å¸ƒæ˜¯é«˜æ–¯åˆ†å¸ƒï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¹Ÿå‡è®¾$p_\theta$æ˜¯é«˜æ–¯åˆ†å¸ƒï¼Œäºæ˜¯æˆ‘ä»¬æœ‰:</p>

<p>
\begin{equation}
p_\theta(\mathbf{x}_{0:T}) = p(\mathbf{x}_T) \prod^T_{t=1} p_\theta(\mathbf{x}_{t-1} \vert \mathbf{x}_t) \quad
p_\theta(\mathbf{x}_{t-1} \vert \mathbf{x}_t) = \mathcal{N}(\mathbf{x}_{t-1}; \boldsymbol{\mu}_\theta(\mathbf{x}_t, t), \boldsymbol{\Sigma}_\theta(\mathbf{x}_t, t))
\end{equation}
</p>

<p>å…¶ä¸­åˆ†å¸ƒ$p_\theta$ä¸­çš„å‡å€¼$\mu$å’Œæ–¹å·®$\Sigma$ä¸æ—¶é—´æ­¥tå’Œè¾“å…¥$x_t$æœ‰å…³</p>

<p>è™½ç„¶æˆ‘ä»¬ä¸çŸ¥é“$q(x_{t-1}|x_t)$çš„åˆ†å¸ƒæƒ…å†µï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çŸ¥é“$q(\mathbf{x}_{t-1} \vert \mathbf{x}_t, \mathbf{x}_0)$çš„åˆ†å¸ƒæƒ…å†µï¼Œæ¨å¯¼è¿‡ç¨‹å¦‚ä¸‹:</p>

<p style="font-size: 14px">
\begin{equation}
\begin{aligned}
q\left(\mathbf{x}_{t-1} \mid \mathbf{x}_t, \mathbf{x}_0\right) &amp;=q\left(\mathbf{x}_t \mid \mathbf{x}_{t-1}, \mathbf{x}_0\right) \frac{q\left(\mathbf{x}_{t-1} \mid \mathbf{x}_0\right)}{q\left(\mathbf{x}_t \mid \mathbf{x}_0\right)} \\
&amp; \propto \exp \left(-\frac{1}{2}\left(\frac{\left(\mathbf{x}_t-\sqrt{\alpha_t} \mathbf{x}_{t-1}\right)^2}{\beta_t}+\frac{\left(\mathbf{x}_{t-1}-\sqrt{\bar{\alpha}_{t-1}} \mathbf{x}_0\right)^2}{1-\bar{\alpha}_{t-1}}-\frac{\left(\mathbf{x}_t-\sqrt{\bar{\alpha}_t} \mathbf{x}_0\right)^2}{1-\bar{\alpha}_t}\right)\right) \\
&amp;=\exp \left(-\frac{1}{2}\left(\frac{\mathbf{x}_t^2-2 \sqrt{\alpha_t} \mathbf{x}_t \mathbf{x}_{t-1}+\alpha_t \mathbf{x}_{t-1}^2}{\beta_t}+\frac{\mathbf{x}_{t-1}^2-2 \sqrt{\bar{\alpha}_{t-1}} \mathbf{x}_0 \mathbf{x}_{t-1}+\bar{\alpha}_{t-1} \mathbf{x}_0^2}{1-\bar{\alpha}_{t-1}}-\frac{\left(\mathbf{x}_t-\sqrt{\bar{\alpha}_t} \mathbf{x}_0\right)^2}{1-\bar{\alpha}_t}\right)\right) \\
&amp;=\exp \left(-\frac{1}{2}\left(\left(\frac{\alpha_t}{\beta_t}+\frac{1}{1-\bar{\alpha}_{t-1}}\right) \mathbf{x}_{t-1}^2-\left(\frac{2 \sqrt{\alpha_t}}{\beta_t} \mathbf{x}_t+\frac{2 \sqrt{\bar{\alpha}_{t-1}}}{1-\bar{\alpha}_{t-1}} \mathbf{x}_0\right) \mathbf{x}_{t-1}+C\left(\mathbf{x}_t, \mathbf{x}_0\right)\right)\right)
\end{aligned}
\end{equation}
</p>

<p>å…¶ä¸­å‡½æ•°$C(x_t, x_0)$ä¸$x_{t-1}$æ— å…³ï¼Œæ ¹æ®ä¸Šè¿°å¼å­æˆ‘ä»¬å¯ä»¥å¾—å‡º$q(x_{t-1}|x_t,x_0)$æ»¡è¶³æ­£æ€åˆ†å¸ƒï¼Œå‡å€¼å’Œæ ‡å‡†å·®åˆ†åˆ«ä¸º$\tilde{\mu_t}$å’Œ$\tilde{\beta_t}$ï¼Œè¡¨è¾¾å¼åˆ†åˆ«ä¸º:</p>

<p>
\begin{equation}
\begin{aligned}
\tilde{\beta}_t 
&amp;= 1/(\frac{\alpha_t}{\beta_t} + \frac{1}{1 - \bar{\alpha}_{t-1}}) 
= 1/(\frac{\alpha_t - \bar{\alpha}_t + \beta_t}{\beta_t(1 - \bar{\alpha}_{t-1})})
= \color{green}{\frac{1 - \bar{\alpha}_{t-1}}{1 - \bar{\alpha}_t} \cdot \beta_t} \\
\tilde{\boldsymbol{\mu}}_t (\mathbf{x}_t, \mathbf{x}_0)
&amp;= (\frac{\sqrt{\alpha_t}}{\beta_t} \mathbf{x}_t + \frac{\sqrt{\bar{\alpha}_{t-1} }}{1 - \bar{\alpha}_{t-1}} \mathbf{x}_0)/(\frac{\alpha_t}{\beta_t} + \frac{1}{1 - \bar{\alpha}_{t-1}}) \\
&amp;= (\frac{\sqrt{\alpha_t}}{\beta_t} \mathbf{x}_t + \frac{\sqrt{\bar{\alpha}_{t-1} }}{1 - \bar{\alpha}_{t-1}} \mathbf{x}_0) \color{green}{\frac{1 - \bar{\alpha}_{t-1}}{1 - \bar{\alpha}_t} \cdot \beta_t} \\
&amp;= \frac{\sqrt{\alpha_t}(1 - \bar{\alpha}_{t-1})}{1 - \bar{\alpha}_t} \mathbf{x}_t + \frac{\sqrt{\bar{\alpha}_{t-1}}\beta_t}{1 - \bar{\alpha}_t} \mathbf{x}_0\\
\end{aligned}
</p>

<p>
\begin{equation}
q(\mathbf{x}_{t-1} \vert \mathbf{x}_t, \mathbf{x}_0) = \mathcal{N}(\mathbf{x}_{t-1}; \tilde{\boldsymbol{\mu}}(\mathbf{x}_t, \mathbf{x}_0), \tilde{\beta}_t \mathbf{I})
\end{equation}
</p>
:ET